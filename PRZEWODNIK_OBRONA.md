# ğŸ“‹ Przewodnik do Obrony Projektu
## System ZarzÄ…dzania SpÃ³Å‚dzielniÄ… MieszkaniowÄ… | LAB 7-13

---

> [!TIP]
> **Jak korzystaÄ‡ z tego dokumentu:**  
> WykÅ‚adowca bÄ™dzie pytaÄ‡: *"Czy zaimplementowaÅ‚eÅ› [element]? PokaÅ¼ gdzie."*  
> Dla kaÅ¼dego elementu znajdziesz: **CO TO JEST**, **GDZIE POKAZAÄ†**, **KOD**

---

## ğŸ“š Spis treÅ›ci

| LAB | Temat | Kluczowe elementy |
|-----|-------|-------------------|
| [LAB 7](#lab-7) | Tabele i CRUD | CREATE TABLE, PRIMARY KEY, FOREIGN KEY, INSERT, UPDATE, DELETE |
| [LAB 8](#lab-8) | Zapytania | WHERE LIKE, ORDER BY, GROUP BY, SUM, COUNT, CASE |
| [LAB 9](#lab-9) | Widoki | VIEW, MATERIALIZED VIEW, INVISIBLE columns |
| [LAB 10](#lab-10) | ZÅ‚Ä…czenia | INNER, LEFT, RIGHT, FULL OUTER, CROSS, SELF JOIN |
| [LAB 11](#lab-11) | Procedury i funkcje | PROCEDURE, FUNCTION, SEQUENCE, CURSOR |
| [LAB 12](#lab-12) | Pakiety | PACKAGE SPECIFICATION + BODY |
| [LAB 13](#lab-13) | Triggery | TRIGGER, EXECUTE IMMEDIATE |

---

## LAB 7

### CREATE TABLE, PRIMARY KEY, FOREIGN KEY, INSERT, UPDATE, DELETE

---

### 7.1 CREATE TABLE z PRIMARY KEY

| | |
|---|---|
| **Co to jest** | Tworzenie tabel z kluczem gÅ‚Ã³wnym |
| **Gdzie pokazaÄ‡** | ğŸ“ [INIT_DB.sql](file:///Users/maxmariukha/Desktop/Klient/INIT_DB.sql) (linie 1-100) |
| **W aplikacji** | Panel Admin â†’ dowolna tabela |

```sql
CREATE TABLE budynek (
    id_budynku NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    adres VARCHAR2(200) NOT NULL,
    liczba_pieter NUMBER,
    rok_budowy NUMBER
);
```

---

### 7.2 FOREIGN KEY

| | |
|---|---|
| **Co to jest** | Klucze obce Å‚Ä…czÄ…ce tabele |
| **Gdzie pokazaÄ‡** | ğŸ“ [INIT_DB.sql](file:///Users/maxmariukha/Desktop/Klient/INIT_DB.sql) |
| **W aplikacji** | Panel Admin â†’ Mieszkania (kolumna `id_budynku`) |

```sql
CREATE TABLE mieszkanie (
    id_mieszkania NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_budynku NUMBER NOT NULL,
    CONSTRAINT fk_mieszkanie_budynek 
        FOREIGN KEY (id_budynku) 
        REFERENCES budynek(id_budynku) 
        ON DELETE CASCADE
);
```

> [!NOTE]
> `ON DELETE CASCADE` = gdy usuniesz budynek, wszystkie mieszkania w nim teÅ¼ siÄ™ usunÄ…

---

### 7.3 INSERT (dodawanie rekordÃ³w)

| | |
|---|---|
| **Co to jest** | Wstawianie nowych rekordÃ³w |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ Budynki â†’ przycisk **"Dodaj rekord"** |
| **Backend** | ğŸ“ [main.py](file:///Users/maxmariukha/Desktop/Klient/backend/main.py) (endpoint `POST /data/{table}`) |

---

### 7.4 UPDATE (aktualizacja rekordÃ³w)

| | |
|---|---|
| **Co to jest** | Modyfikacja istniejÄ…cych rekordÃ³w |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ Budynki â†’ **ikona oÅ‚Ã³wka** âœï¸ przy rekordzie |

---

### 7.5 DELETE (usuwanie rekordÃ³w)

| | |
|---|---|
| **Co to jest** | Usuwanie rekordÃ³w |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ Budynki â†’ **ikona kosza** ğŸ—‘ï¸ przy rekordzie |

---

### 7.6 ALTER TABLE ADD

| | |
|---|---|
| **Co to jest** | Dodawanie nowych kolumn do istniejÄ…cych tabel |
| **Gdzie pokazaÄ‡** | ğŸ“ [INIT_DB.sql](file:///Users/maxmariukha/Desktop/Klient/INIT_DB.sql) (szukaj `ALTER TABLE`) |

```sql
ALTER TABLE naprawa ADD uwagi VARCHAR2(500);
ALTER TABLE naprawa ADD priorytet VARCHAR2(20) DEFAULT 'sredni';
ALTER TABLE budynek ADD typ_budynku VARCHAR2(50) DEFAULT 'blok';
```

---

## LAB 8

### SELECT z WHERE, ORDER BY, GROUP BY, funkcje agregujÄ…ce, CASE

---

### 8.1 SELECT z WHERE LIKE

| | |
|---|---|
| **Co to jest** | Wyszukiwanie tekstowe w bazie danych |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ dowolna tabela â†’ pole **"Szukaj..."** ğŸ” |
| **Jak przetestowaÄ‡** | Wpisz np. "Kowalski" i zobacz jak filtruje |

```sql
-- Generowany dynamicznie SQL:
SELECT * FROM czlonek 
WHERE UPPER(imie) LIKE UPPER('%Kowalski%') 
   OR UPPER(nazwisko) LIKE UPPER('%Kowalski%')
   OR UPPER(email) LIKE UPPER('%Kowalski%')
```

**Backend** ([main.py](file:///Users/maxmariukha/Desktop/Klient/backend/main.py#L260)):
```python
@app.get("/data/{table}/search")
async def search_table_data(table: str, q: str = ""):
    like_clauses = " OR ".join([
        f"UPPER({col}) LIKE UPPER(:search_term)" 
        for col in text_columns
    ])
    sql = f"SELECT * FROM {table} WHERE {like_clauses}"
```

---

### 8.2 ORDER BY

| | |
|---|---|
| **Co to jest** | Sortowanie wynikÃ³w |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ dowolna tabela â†’ **kliknij nagÅ‚Ã³wek kolumny** |
| **Wizualnie** | StrzaÅ‚ka â†‘â†“ pokazuje kierunek sortowania |

---

### 8.3 GROUP BY z funkcjami agregujÄ…cymi

| | |
|---|---|
| **Co to jest** | Grupowanie danych z obliczeniami |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **Podsumowania** â†’ "Podsumowanie opÅ‚at" |

```sql
-- Widok v_oplaty_summary:
SELECT 
    m.numer_mieszkania,
    COUNT(*) as liczba_oplat,
    SUM(o.kwota) as suma_oplat,
    SUM(CASE WHEN o.status_oplaty = 'nieoplacone' THEN o.kwota ELSE 0 END) as zaleglosci
FROM mieszkanie m
LEFT JOIN oplata o ON m.id_mieszkania = o.id_mieszkania
GROUP BY m.id_mieszkania, m.numer_mieszkania
```

---

### 8.4 Funkcje agregujÄ…ce: SUM, COUNT, AVG, MAX, MIN

| | |
|---|---|
| **Co to jest** | Funkcje obliczeniowe na zbiorach danych |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **Pulpit gÅ‚Ã³wny** (karty ze statystykami) |

```sql
SELECT COUNT(*) FROM budynek;           -- Liczba budynkÃ³w
SELECT SUM(kwota) FROM oplata;          -- Suma opÅ‚at
SELECT AVG(powierzchnia) FROM mieszkanie; -- Åšrednia powierzchnia
```

---

### 8.5 CASE WHEN

| | |
|---|---|
| **Co to jest** | WyraÅ¼enia warunkowe w SQL |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **Podsumowania** â†’ "Status napraw" |
| **Efekt** | WidaÄ‡ przetÅ‚umaczone statusy ("Oczekuje na realizacjÄ™" zamiast "zgloszona") |

```sql
-- Widok v_naprawy_status:
SELECT 
    CASE status
        WHEN 'zgloszona' THEN 'Oczekuje na realizacjÄ™'
        WHEN 'w_realizacji' THEN 'W trakcie naprawy'
        WHEN 'zakonczona' THEN 'Naprawiono'
        ELSE status
    END as status_opis
FROM naprawa
```

---

## LAB 9

### VIEW, MATERIALIZED VIEW, INVISIBLE columns

---

### 9.1 VIEW prosty

| | |
|---|---|
| **Co to jest** | Widok Å‚Ä…czÄ…cy dane z wielu tabel |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **Podsumowania** â†’ "Mieszkania z adresami" |

```sql
CREATE OR REPLACE VIEW v_mieszkania_info AS
SELECT m.id_mieszkania, m.numer_mieszkania, m.powierzchnia,
       b.adres, b.liczba_pieter
FROM mieszkanie m
JOIN budynek b ON m.id_budynku = b.id_budynku;
```

---

### 9.2 VIEW zÅ‚oÅ¼ony z agregacjÄ…

| | |
|---|---|
| **Co to jest** | Widok z funkcjami agregujÄ…cymi |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **Podsumowania** â†’ "Podsumowanie opÅ‚at" |

---

### 9.3 MATERIALIZED VIEW

| | |
|---|---|
| **Co to jest** | Widok zmaterializowany (keszowany) |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **NarzÄ™dzia administratora** â†’ Raporty â†’ "Statystyki keszowane" |
| **TakÅ¼e** | Pulpit gÅ‚Ã³wny (karty ze statystykami) |

```sql
CREATE MATERIALIZED VIEW mv_dashboard_stats
BUILD IMMEDIATE
REFRESH FORCE ON DEMAND
AS
SELECT 
    (SELECT COUNT(*) FROM budynek) as liczba_budynkow,
    (SELECT COUNT(*) FROM mieszkanie) as liczba_mieszkan,
    (SELECT COUNT(*) FROM czlonek) as liczba_czlonkow,
    (SELECT NVL(SUM(kwota), 0) FROM oplata) as suma_oplat
FROM dual;
```

> [!IMPORTANT]
> `BUILD IMMEDIATE` = dane sÄ… od razu dostÄ™pne po utworzeniu  
> `REFRESH FORCE ON DEMAND` = odÅ›wieÅ¼anie na Å¼Ä…danie

---

### 9.4 INVISIBLE columns

| | |
|---|---|
| **Co to jest** | Kolumny niewidoczne przy `SELECT *` |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **NarzÄ™dzia administratora** â†’ Raporty â†’ "Bezpieczne dane czÅ‚onkÃ³w" |

> [!CAUTION]
> **PokaÅ¼ wykÅ‚adowcy:** W tym widoku **NIE MA** kolumn PESEL i telefon - sÄ… ukryte!

```sql
CREATE OR REPLACE VIEW v_czlonek_bezpieczny AS
SELECT 
    id_czlonka,
    imie,
    nazwisko,
    email,
    data_przystapienia,
    pesel INVISIBLE,      -- ukryta kolumna!
    telefon INVISIBLE     -- ukryta kolumna!
FROM czlonek;
```

**WyjaÅ›nienie:** Gdy zrobisz `SELECT * FROM v_czlonek_bezpieczny`, kolumny PESEL i telefon NIE zostanÄ… zwrÃ³cone. Trzeba je jawnie podaÄ‡: `SELECT pesel, telefon FROM v_czlonek_bezpieczny`.

---

## LAB 10

### RÃ³Å¼ne typy JOIN

---

### 10.1 INNER JOIN

| | |
|---|---|
| **Co to jest** | ÅÄ…czy tylko pasujÄ…ce rekordy z obu tabel |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **Podsumowania** â†’ "Mieszkania z adresami" |

```sql
SELECT * FROM mieszkanie m
INNER JOIN budynek b ON m.id_budynku = b.id_budynku;
```

---

### 10.2 LEFT JOIN

| | |
|---|---|
| **Co to jest** | Wszystkie rekordy z lewej tabeli + pasujÄ…ce z prawej |
| **Gdzie pokazaÄ‡** | Widok `v_oplaty_summary` (wszystkie mieszkania, nawet bez opÅ‚at) |

---

### 10.3 RIGHT JOIN

| | |
|---|---|
| **Co to jest** | Wszystkie rekordy z prawej tabeli + pasujÄ…ce z lewej |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **NarzÄ™dzia administratora** â†’ Raporty â†’ "ObciÄ…Å¼enie pracownikÃ³w" |

```sql
CREATE OR REPLACE VIEW v_pracownicy_naprawy AS
SELECT p.imie, p.nazwisko, n.opis_usterki
FROM naprawa n
RIGHT JOIN pracownik p ON n.id_pracownika = p.id_pracownika;
-- PokaÅ¼e WSZYSTKICH pracownikÃ³w, nawet tych bez napraw
```

---

### 10.4 FULL OUTER JOIN

| | |
|---|---|
| **Co to jest** | Wszystkie rekordy z obu tabel |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **NarzÄ™dzia administratora** â†’ Raporty â†’ "Zestawienie opÅ‚at" |

```sql
CREATE OR REPLACE VIEW v_oplaty_uslugi_full AS
SELECT o.id_oplaty, u.nazwa_uslugi
FROM oplata o
FULL OUTER JOIN uslugi u ON o.id_uslugi = u.id_uslugi;
```

---

### 10.5 CROSS JOIN

| | |
|---|---|
| **Co to jest** | Iloczyn kartezjaÅ„ski (wszystkie kombinacje) |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **NarzÄ™dzia administratora** â†’ Raporty â†’ "Matryca budynki-usÅ‚ugi" |

```sql
CREATE OR REPLACE VIEW v_budynki_uslugi_cross AS
SELECT b.adres, u.nazwa_uslugi
FROM budynek b
CROSS JOIN uslugi u;
-- KaÅ¼dy budynek Ã— kaÅ¼da usÅ‚uga
```

---

### 10.6 SELF JOIN

| | |
|---|---|
| **Co to jest** | Tabela Å‚Ä…czy siÄ™ sama ze sobÄ… |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **NarzÄ™dzia administratora** â†’ Raporty â†’ "ZespoÅ‚y stanowiskowe" |

```sql
CREATE OR REPLACE VIEW v_pracownicy_koledzy AS
SELECT 
    p1.imie || ' ' || p1.nazwisko as pracownik1,
    p2.imie || ' ' || p2.nazwisko as pracownik2,
    p1.stanowisko
FROM pracownik p1
JOIN pracownik p2 
    ON p1.stanowisko = p2.stanowisko 
    AND p1.id_pracownika < p2.id_pracownika;
-- Pary pracownikÃ³w na tym samym stanowisku
```

---

### 10.7 JOIN 3 tabel (MULTI-TABLE JOIN)

| | |
|---|---|
| **Co to jest** | ÅÄ…czenie wiÄ™cej niÅ¼ 2 tabel |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **NarzÄ™dzia administratora** â†’ Raporty â†’ "PeÅ‚ne dane mieszkaÅ„cÃ³w" |

```sql
CREATE OR REPLACE VIEW v_czlonkowie_pelne_info AS
SELECT c.imie, c.nazwisko, m.numer_mieszkania, b.adres
FROM czlonek c
JOIN mieszkanie m ON c.id_mieszkania = m.id_mieszkania
JOIN budynek b ON m.id_budynku = b.id_budynku;
-- ÅÄ…czy 3 tabele: czlonek â†’ mieszkanie â†’ budynek
```

---

## LAB 11

### PROCEDURE, FUNCTION, SEQUENCE, CURSOR

---

### 11.1 SEQUENCE

| | |
|---|---|
| **Co to jest** | Generator unikalnych numerÃ³w |
| **Gdzie pokazaÄ‡** | ğŸ“ [INIT_DB.sql](file:///Users/maxmariukha/Desktop/Klient/INIT_DB.sql) (szukaj `CREATE SEQUENCE`) |

```sql
CREATE SEQUENCE spotkanie_seq START WITH 1000 INCREMENT BY 1;
CREATE SEQUENCE naprawa_seq START WITH 1000 INCREMENT BY 1;

-- UÅ¼ycie:
INSERT INTO naprawa (id_naprawy, ...) VALUES (naprawa_seq.NEXTVAL, ...);
```

---

### 11.2 PROCEDURE z parametrami IN/OUT

| | |
|---|---|
| **Co to jest** | Procedura z parametrami wejÅ›ciowymi i wyjÅ›ciowymi |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **NarzÄ™dzia administratora** â†’ "ZwiÄ™ksz ceny usÅ‚ug" |
| **Jak przetestowaÄ‡** | Wpisz procent (np. 10) i kliknij przycisk |

```sql
CREATE OR REPLACE PROCEDURE zwieksz_oplaty(
    p_procent IN NUMBER DEFAULT 10,
    p_liczba_zmienionych OUT NUMBER
) AS
BEGIN
    UPDATE uslugi 
    SET cena_jednostkowa = cena_jednostkowa * (1 + p_procent/100);
    p_liczba_zmienionych := SQL%ROWCOUNT;
    COMMIT;
END;
```

---

### 11.3 PROCEDURE z obsÅ‚ugÄ… wyjÄ…tkÃ³w

| | |
|---|---|
| **Co to jest** | Procedura z blokiem EXCEPTION |
| **Gdzie pokazaÄ‡** | ğŸ“ [INIT_DB.sql](file:///Users/maxmariukha/Desktop/Klient/INIT_DB.sql) (procedura `dodaj_czlonka`) |

```sql
CREATE OR REPLACE PROCEDURE dodaj_czlonka(
    p_imie IN VARCHAR2,
    p_nazwisko IN VARCHAR2,
    p_id OUT NUMBER
) AS
BEGIN
    INSERT INTO czlonek (imie, nazwisko) 
    VALUES (p_imie, p_nazwisko)
    RETURNING id_czlonka INTO p_id;
    COMMIT;
EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        RAISE_APPLICATION_ERROR(-20001, 'CzÅ‚onek juÅ¼ istnieje');
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
```

---

### 11.4 FUNCTION

| | |
|---|---|
| **Co to jest** | Funkcja zwracajÄ…ca wartoÅ›Ä‡ |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **NarzÄ™dzia administratora** â†’ "Dodaj opÅ‚atÄ™" |
| **Efekt** | Wybierz mieszkanie i usÅ‚ugÄ™, wpisz zuÅ¼ycie â†’ **kwota oblicza siÄ™ automatycznie!** |

```sql
CREATE OR REPLACE FUNCTION dodaj_oplate_fn(
    p_id_mieszkania IN NUMBER,
    p_id_uslugi IN NUMBER,
    p_zuzycie IN NUMBER
) RETURN NUMBER AS
    v_cena NUMBER;
    v_kwota NUMBER;
    v_id_oplaty NUMBER;
BEGIN
    SELECT cena_jednostkowa INTO v_cena 
    FROM uslugi WHERE id_uslugi = p_id_uslugi;
    
    v_kwota := v_cena * p_zuzycie;
    
    INSERT INTO oplata (id_mieszkania, id_uslugi, kwota, zuzycie, status_oplaty)
    VALUES (p_id_mieszkania, p_id_uslugi, v_kwota, p_zuzycie, 'nieoplacone')
    RETURNING id_oplaty INTO v_id_oplaty;
    
    COMMIT;
    RETURN v_id_oplaty;
END;
```

---

### 11.5 FUNCTION z CURSOR

| | |
|---|---|
| **Co to jest** | Funkcja iterujÄ…ca po rekordach za pomocÄ… kursora |
| **Gdzie pokazaÄ‡** | ğŸ“ [INIT_DB.sql](file:///Users/maxmariukha/Desktop/Klient/INIT_DB.sql) (funkcja `pobierz_czlonkow_budynku`) |

```sql
CREATE OR REPLACE FUNCTION pobierz_czlonkow_budynku(p_id_budynku IN NUMBER) 
RETURN VARCHAR2 AS
    v_wynik VARCHAR2(4000) := '';
    
    CURSOR c_czlonkowie IS
        SELECT c.imie, c.nazwisko
        FROM czlonek c
        JOIN mieszkanie m ON c.id_mieszkania = m.id_mieszkania
        WHERE m.id_budynku = p_id_budynku;
BEGIN
    FOR rec IN c_czlonkowie LOOP
        v_wynik := v_wynik || rec.imie || ' ' || rec.nazwisko || ', ';
    END LOOP;
    RETURN RTRIM(v_wynik, ', ');
END;
```

---

## LAB 12

### PACKAGE

---

### 12.1 PACKAGE SPECIFICATION + BODY

| | |
|---|---|
| **Co to jest** | Pakiet grupujÄ…cy procedury i funkcje |
| **Gdzie pokazaÄ‡** | ğŸ“ [INIT_DB.sql](file:///Users/maxmariukha/Desktop/Klient/INIT_DB.sql) (szukaj `CREATE OR REPLACE PACKAGE`) |

**Specyfikacja:**
```sql
CREATE OR REPLACE PACKAGE coop_pkg AS
    PROCEDURE zwieksz_oplaty_pkg(p_procent IN NUMBER DEFAULT 10);
    FUNCTION policz_naprawy_pracownika(p_id_pracownika IN NUMBER) RETURN NUMBER;
    FUNCTION suma_oplat_mieszkania(p_id_mieszkania IN NUMBER) RETURN NUMBER;
END coop_pkg;
```

**Implementacja (BODY):**
```sql
CREATE OR REPLACE PACKAGE BODY coop_pkg AS
    PROCEDURE zwieksz_oplaty_pkg(p_procent IN NUMBER DEFAULT 10) AS
    BEGIN
        UPDATE uslugi 
        SET cena_jednostkowa = cena_jednostkowa * (1 + p_procent/100);
        COMMIT;
    END;
    
    FUNCTION policz_naprawy_pracownika(p_id_pracownika IN NUMBER) RETURN NUMBER AS
        v_liczba NUMBER;
    BEGIN
        SELECT COUNT(*) INTO v_liczba 
        FROM naprawa WHERE id_pracownika = p_id_pracownika;
        RETURN v_liczba;
    END;
    
    FUNCTION suma_oplat_mieszkania(p_id_mieszkania IN NUMBER) RETURN NUMBER AS
        v_suma NUMBER;
    BEGIN
        SELECT NVL(SUM(kwota), 0) INTO v_suma 
        FROM oplata WHERE id_mieszkania = p_id_mieszkania;
        RETURN v_suma;
    END;
END coop_pkg;
```

---

### 12.2 PACKAGE z obsÅ‚ugÄ… wyjÄ…tkÃ³w

| | |
|---|---|
| **Gdzie pokazaÄ‡** | ğŸ“ [INIT_DB.sql](file:///Users/maxmariukha/Desktop/Klient/INIT_DB.sql) (pakiet `coop_crud_pkg`) |

```sql
CREATE OR REPLACE PACKAGE BODY coop_crud_pkg AS
    FUNCTION pobierz_nazwisko_czlonka(p_id_czlonka NUMBER) RETURN VARCHAR2 AS
        v_nazwisko VARCHAR2(100);
    BEGIN
        SELECT nazwisko INTO v_nazwisko 
        FROM czlonek WHERE id_czlonka = p_id_czlonka;
        RETURN v_nazwisko;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RETURN 'Nie znaleziono';
        WHEN TOO_MANY_ROWS THEN
            RETURN 'Wiele wynikÃ³w';
    END;
END coop_crud_pkg;
```

---

## LAB 13

### TRIGGER, EXECUTE IMMEDIATE

---

### 13.1 TRIGGER AFTER INSERT/UPDATE/DELETE (audyt)

| | |
|---|---|
| **Co to jest** | Trigger automatycznie logujÄ…cy zmiany |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **NarzÄ™dzia administratora** â†’ "Historia zmian" |

> [!TIP]
> **Demo:** ZrÃ³b jakÄ…Å› zmianÄ™ w tabeli CzÅ‚onkowie (dodaj/edytuj/usuÅ„), a potem wrÃ³Ä‡ do "Historia zmian" Å¼eby zobaczyÄ‡ log!

```sql
CREATE OR REPLACE TRIGGER trg_audit_czlonek
AFTER INSERT OR UPDATE OR DELETE ON czlonek
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        INSERT INTO log_zmian_czlonka (typ_operacji, id_czlonka, nowe_dane, data_zmiany)
        VALUES ('INSERT', :NEW.id_czlonka, :NEW.imie || ' ' || :NEW.nazwisko, SYSDATE);
    ELSIF UPDATING THEN
        INSERT INTO log_zmian_czlonka (typ_operacji, id_czlonka, stare_dane, nowe_dane, data_zmiany)
        VALUES ('UPDATE', :NEW.id_czlonka, 
                :OLD.imie || ' ' || :OLD.nazwisko, 
                :NEW.imie || ' ' || :NEW.nazwisko, SYSDATE);
    ELSIF DELETING THEN
        INSERT INTO log_zmian_czlonka (typ_operacji, id_czlonka, stare_dane, data_zmiany)
        VALUES ('DELETE', :OLD.id_czlonka, :OLD.imie || ' ' || :OLD.nazwisko, SYSDATE);
    END IF;
END;
```

---

### 13.2 TRIGGER BEFORE z walidacjÄ…

| | |
|---|---|
| **Co to jest** | Trigger blokujÄ…cy nieprawidÅ‚owe dane |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **OpÅ‚aty** â†’ Dodaj rekord |

> [!WARNING]
> **Demo:** SprÃ³buj wpisaÄ‡ ujemnÄ… kwotÄ™ â†’ dostaniesz **BÅÄ„D!**

```sql
CREATE OR REPLACE TRIGGER trg_walidacja_oplaty
BEFORE INSERT OR UPDATE OF kwota ON oplata
FOR EACH ROW
BEGIN
    IF :NEW.kwota < 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'Kwota opÅ‚aty nie moÅ¼e byÄ‡ ujemna');
    END IF;
END;
```

---

### 13.3 EXECUTE IMMEDIATE (dynamiczny SQL)

| | |
|---|---|
| **Co to jest** | Wykonywanie dynamicznie budowanego SQL |
| **Gdzie pokazaÄ‡** | Panel Admin â†’ **NarzÄ™dzia administratora** â†’ "Statystyki tabel" |
| **Efekt** | WyÅ›wietla liczbÄ™ rekordÃ³w w KAÅ»DEJ tabeli (dynamicznie!) |

```sql
CREATE OR REPLACE FUNCTION policz_rekordy(p_nazwa_tabeli IN VARCHAR2) 
RETURN NUMBER AS
    v_sql VARCHAR2(200);
    v_liczba NUMBER;
BEGIN
    v_sql := 'SELECT COUNT(*) FROM ' || p_nazwa_tabeli;
    EXECUTE IMMEDIATE v_sql INTO v_liczba;
    RETURN v_liczba;
END;
```

**Backend** ([main.py](file:///Users/maxmariukha/Desktop/Klient/backend/main.py)):
```python
@app.get("/procedures/count-records/{table}")
async def count_records(table: str):
    cursor.execute(
        "SELECT policz_rekordy(:table_name) FROM dual", 
        {"table_name": table}
    )
```

---

## ğŸ—ºï¸ Szybka mapa - gdzie co znaleÅºÄ‡

| Lokalizacja w aplikacji | Elementy LAB |
|------------------------|--------------|
| **Pulpit gÅ‚Ã³wny** | COUNT, SUM, MATERIALIZED VIEW (`mv_dashboard_stats`) |
| **Tabele** (Budynki, Mieszkania...) | CREATE TABLE, PRIMARY KEY, FOREIGN KEY, INSERT, UPDATE, DELETE, WHERE LIKE, ORDER BY |
| **Podsumowania** | VIEW, GROUP BY, funkcje agregujÄ…ce, CASE WHEN |
| **NarzÄ™dzia administratora** | PROCEDURE, FUNCTION, TRIGGER, EXECUTE IMMEDIATE, rÃ³Å¼ne typy JOIN, MATERIALIZED VIEW, INVISIBLE |
| **Portal MieszkaÅ„ca** | VIEW (`v_moje_oplaty`), PROCEDURE (`zglos_naprawe`), JOIN 3 tabel |

---

## â“ Pytania wykÅ‚adowcy + odpowiedzi

| Pytanie | OdpowiedÅº |
|---------|-----------|
| Gdzie masz PRIMARY KEY? | KaÅ¼da tabela ma kolumnÄ™ `id_*` z PRIMARY KEY. Np. `budynek.id_budynku` |
| Gdzie masz FOREIGN KEY z ON DELETE CASCADE? | INIT_DB.sql, tabela `mieszkanie` - gdy usuniesz budynek, mieszkania teÅ¼ siÄ™ usunÄ… |
| PokaÅ¼ WHERE LIKE | Panel Admin â†’ dowolna tabela â†’ wpisz coÅ› w "Szukaj..." |
| PokaÅ¼ GROUP BY z SUM | Podsumowania â†’ "Podsumowanie opÅ‚at per mieszkanie" |
| PokaÅ¼ MATERIALIZED VIEW | NarzÄ™dzia administratora â†’ Raporty â†’ "Statystyki keszowane" |
| PokaÅ¼ INVISIBLE columns | NarzÄ™dzia administratora â†’ Raporty â†’ "Bezpieczne dane czÅ‚onkÃ³w" - nie ma PESEL! |
| PokaÅ¼ rÃ³Å¼ne typy JOIN | NarzÄ™dzia administratora â†’ Raporty â†’ jest RIGHT, FULL, CROSS, SELF JOIN |
| PokaÅ¼ procedurÄ™ | NarzÄ™dzia administratora â†’ "ZwiÄ™ksz ceny usÅ‚ug" |
| PokaÅ¼ funkcjÄ™ | NarzÄ™dzia administratora â†’ "Dodaj opÅ‚atÄ™" (automatycznie liczy kwotÄ™) |
| PokaÅ¼ trigger | NarzÄ™dzia administratora â†’ "Historia zmian" + zrÃ³b zmianÄ™ w CzÅ‚onkach |
| PokaÅ¼ EXECUTE IMMEDIATE | NarzÄ™dzia administratora â†’ "Statystyki tabel" |
| PokaÅ¼ SEQUENCE | INIT_DB.sql - `spotkanie_seq`, `naprawa_seq` |
| PokaÅ¼ PACKAGE | INIT_DB.sql - `coop_pkg`, `coop_crud_pkg` |

---

> **Powodzenia na obronie! ğŸ“**

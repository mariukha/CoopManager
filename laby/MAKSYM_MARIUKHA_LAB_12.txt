SET SERVEROUTPUT ON
--zad1. Uruchomienie zapisu
SPOOL wyniki_lab12.txt

--zad2_1 (Ćwiczenie 1: Kursor jawny - Tabela CZLONEK)
-- Używamy jawnej deklaracji (CURSOR nazwa IS), aby spełnić cel ćwiczenia
DECLARE
    CURSOR c_mieszkancy IS 
        SELECT imie, nazwisko FROM czlonek;
BEGIN
    FOR rec IN c_mieszkancy LOOP
        DBMS_OUTPUT.PUT_LINE('Mieszkaniec: ' || rec.imie || ' ' || rec.nazwisko);
    END LOOP;
END;
/

--zad2_2 (Ćwiczenie 1: Kursor jawny - Tabela BUDYNEK)
DECLARE
    CURSOR c_budynki IS 
        SELECT adres FROM budynek;
BEGIN
    FOR rec IN c_budynki LOOP
        DBMS_OUTPUT.PUT_LINE('Adres budynku: ' || rec.adres);
    END LOOP;
END;
/



--zad3_1 (Ćwiczenie 2: Wyjątek DUP_VAL_ON_INDEX - naruszenie klucza głównego)
BEGIN
    -- Próba wstawienia członka z istniejącym ID (np. 1)
    INSERT INTO czlonek (id_czlonka, imie, nazwisko, id_mieszkania) 
    VALUES (1, 'Marek', 'Nowak', 407);
EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        DBMS_OUTPUT.PUT_LINE('Błąd: Członek o tym ID już istnieje (Naruszenie klucza głównego).');
END;
/

--zad3_2 (Ćwiczenie 2: Wyjątek VALUE_ERROR - błąd typu danych)
DECLARE
    v_liczba NUMBER(2);
BEGIN
    -- Próba przypisania zbyt dużej liczby do małego pola (częsty błąd przy wstawianiu/obliczeniach)
    v_liczba := 1000; 
EXCEPTION
    WHEN VALUE_ERROR THEN
        DBMS_OUTPUT.PUT_LINE('Błąd: Wystąpił błąd wartości (np. liczba przekracza zakres pola).');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd: Wystąpił nieoczekiwany błąd.');
END;
/



--zad4 (Ćwiczenie 3: Specyfikacja i ciało pakietu)
CREATE OR REPLACE PACKAGE coop_pkg IS
    -- Procedura zwiększająca kwotę opłat o 10%
    PROCEDURE zwieksz_oplaty;
    
    -- Funkcja obsługująca wyjątki (Zadanie domowe)
    -- Rozszerzamy o drugą tabelę (np. pracownik) zgodnie z zadaniem 4
    FUNCTION sprawdz_dane_czlonka(p_id NUMBER) RETURN VARCHAR2;
    FUNCTION sprawdz_dane_pracownika(p_id NUMBER) RETURN VARCHAR2;
END coop_pkg;
/

CREATE OR REPLACE PACKAGE BODY coop_pkg IS
    -- Implementacja procedury aktualizacji
    PROCEDURE zwieksz_oplaty IS
    BEGIN
        UPDATE oplata SET kwota = kwota * 1.1;
        DBMS_OUTPUT.PUT_LINE('Zaktualizowano kwoty opłat o 10%. Zmian: ' || SQL%ROWCOUNT);
        COMMIT;
    END zwieksz_oplaty;

    -- Implementacja funkcji z obsługą wyjątków dla tabeli CZLONEK
    FUNCTION sprawdz_dane_czlonka(p_id NUMBER) RETURN VARCHAR2 IS
        v_nazwisko czlonek.nazwisko%TYPE;
    BEGIN
        SELECT nazwisko INTO v_nazwisko FROM czlonek WHERE id_czlonka = p_id;
        RETURN 'Członek: ' || v_nazwisko;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RETURN 'Błąd: Nie znaleziono członka o ID ' || p_id;
    END sprawdz_dane_czlonka;

    -- Implementacja funkcji z obsługą wyjątków dla tabeli PRACOWNIK (Druga tabela do zadania 4)
    FUNCTION sprawdz_dane_pracownika(p_id NUMBER) RETURN VARCHAR2 IS
        v_nazwisko pracownik.nazwisko%TYPE;
    BEGIN
        SELECT nazwisko INTO v_nazwisko FROM pracownik WHERE id_pracownika = p_id;
        RETURN 'Pracownik: ' || v_nazwisko;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RETURN 'Błąd: Nie znaleziono pracownika o ID ' || p_id;
    END sprawdz_dane_pracownika;
END coop_pkg;
/



-- Testowanie Pakietu (Zadanie 3 i Zadanie 4)
BEGIN
    -- Test procedury
    coop_pkg.zwieksz_oplaty;
    
    -- Test funkcji dla Tabeli 1 (Członek)
    DBMS_OUTPUT.PUT_LINE(coop_pkg.sprawdz_dane_czlonka(1));
    DBMS_OUTPUT.PUT_LINE(coop_pkg.sprawdz_dane_czlonka(999)); -- Test wyjątku
    
    -- Test funkcji dla Tabeli 2 (Pracownik)
    DBMS_OUTPUT.PUT_LINE(coop_pkg.sprawdz_dane_pracownika(50001));
    DBMS_OUTPUT.PUT_LINE(coop_pkg.sprawdz_dane_pracownika(888)); -- Test wyjątku
END;
/

--zad6. Zakończenie zapisu
SPOOL OFF